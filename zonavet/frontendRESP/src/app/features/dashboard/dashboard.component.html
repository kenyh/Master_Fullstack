<!-- src/app/features/dashboard/dashboard.component.html -->

<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header mb-4">
    <h1 class="text-3xl font-bold text-color">
      Bienvenido, {{ currentUser()?.nombre }}
    </h1>
    <p class="text-color-secondary mt-2">
      Panel de Control - {{ currentUser()?.tipo }}
    </p>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="grid">
      @for (i of [1, 2, 3, 4]; track i) {
        <div class="col-12 md:col-6 lg:col-3">
          <p-skeleton height="120px" />
        </div>
      }
    </div>
  } @else {
    <!-- Estadísticas Principales -->
    <div class="grid mb-4">
      <!-- Total Clientes -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card
          styleClass="stat-card clickable"
          (click)="navigateTo('/clientes')"
        >
          <div class="stat-content">
            <div class="stat-icon bg-blue-100">
              <i class="pi pi-users text-blue-500" style="font-size: 2rem"></i>
            </div>
            <div class="stat-info">
              <h3 class="stat-value">{{ stats().totalClientes }}</h3>
              <p class="stat-label">Clientes</p>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Total Mascotas -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card
          styleClass="stat-card clickable"
          (click)="navigateTo('/mascotas')"
        >
          <div class="stat-content">
            <div class="stat-icon bg-green-100">
              <i
                class="pi pi-heart-fill text-green-500"
                style="font-size: 2rem"
              ></i>
            </div>
            <div class="stat-info">
              <h3 class="stat-value">{{ stats().totalMascotas }}</h3>
              <p class="stat-label">Mascotas</p>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Citas Pendientes -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="stat-card clickable" (click)="navigateTo('/citas')">
          <div class="stat-content">
            <div class="stat-icon bg-orange-100">
              <i
                class="pi pi-calendar text-orange-500"
                style="font-size: 2rem"
              ></i>
            </div>
            <div class="stat-info">
              <h3 class="stat-value">{{ stats().citasPendientes }}</h3>
              <p class="stat-label">Citas Pendientes</p>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Ventas Hoy -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card
          styleClass="stat-card clickable"
          (click)="navigateTo('/ventas')"
        >
          <div class="stat-content">
            <div class="stat-icon bg-purple-100">
              <i
                class="pi pi-shopping-cart text-purple-500"
                style="font-size: 2rem"
              ></i>
            </div>
            <div class="stat-info">
              <h3 class="stat-value">
                {{ stats().ventasDiaActual | formatCurrency }}
              </h3>
              <p class="stat-label">Ventas Hoy ({{ stats().ventasHoy }})</p>
            </div>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Alertas y Información -->
    <div class="grid">
      <!-- Alertas de Stock -->
      @if (isAdmin() || isVendedor()) {
        <div class="col-12 lg:col-6">
          <p-card>
            <ng-template pTemplate="header">
              <div class="card-header-custom">
                <h3>
                  <i
                    class="pi pi-exclamation-triangle text-orange-500 mr-2"
                  ></i>
                  Alertas de Inventario
                </h3>
                <p-chip
                  [label]="stats().alertasStock.toString()"
                  styleClass="bg-orange-100 text-orange-700"
                />
              </div>
            </ng-template>

            @if (productosStockBajo().length > 0) {
              <p-table
                [value]="productosStockBajo()"
                [tableStyle]="{ 'min-width': '100%' }"
                styleClass="p-datatable-sm"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th>Producto</th>
                    <th class="text-center">Stock</th>
                    <th class="text-center">Estado</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-producto>
                  <tr>
                    <td>{{ producto.nombre }}</td>
                    <td class="text-center">
                      <span class="font-semibold">{{ producto.stock }}</span>
                      <span class="text-sm text-color-secondary">
                        / {{ producto.stockMinimo }}</span
                      >
                    </td>
                    <td class="text-center">
                      <p-tag
                        [value]="producto.stock === 0 ? 'SIN STOCK' : 'BAJO'"
                        [severity]="
                          getSeverity(producto.stock, producto.stockMinimo)
                        "
                      />
                    </td>
                  </tr>
                </ng-template>
              </p-table>

              <div class="mt-3 text-center">
                <button
                  pButton
                  label="Ver Todos los Productos"
                  icon="pi pi-arrow-right"
                  class="p-button-text p-button-sm"
                  (click)="navigateTo('/productos')"
                ></button>
              </div>
            } @else {
              <div class="text-center py-4">
                <i
                  class="pi pi-check-circle text-green-500"
                  style="font-size: 3rem"
                ></i>
                <p class="mt-2 text-color-secondary">No hay alertas de stock</p>
              </div>
            }
          </p-card>
        </div>
      }

      <!-- Clientes con Saldo Pendiente -->
      @if (isAdmin() || isVendedor()) {
        <div class="col-12 lg:col-6">
          <p-card>
            <ng-template pTemplate="header">
              <div class="card-header-custom">
                <h3>
                  <i class="pi pi-dollar text-red-500 mr-2"></i>
                  Clientes con Saldo Pendiente
                </h3>
                <p-chip
                  [label]="stats().clientesSaldoPendiente.toString()"
                  styleClass="bg-red-100 text-red-700"
                />
              </div>
            </ng-template>

            @if (clientesSaldoPendiente().length > 0) {
              <p-table
                [value]="clientesSaldoPendiente()"
                [tableStyle]="{ 'min-width': '100%' }"
                styleClass="p-datatable-sm"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th>Cliente</th>
                    <th class="text-right">Saldo</th>
                    <th class="text-center">Acción</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-cliente>
                  <tr>
                    <td>{{ cliente.nombre }}</td>
                    <td class="text-right font-semibold text-red-600">
                      {{ cliente.saldo | formatCurrency }}
                    </td>
                    <td class="text-center">
                      <button
                        pButton
                        icon="pi pi-dollar"
                        class="p-button-rounded p-button-text p-button-sm"
                        pTooltip="Registrar pago"
                        (click)="navigateTo('/ventas')"
                      ></button>
                    </td>
                  </tr>
                </ng-template>
              </p-table>

              <div class="mt-3 text-center">
                <button
                  pButton
                  label="Ver Todos los Clientes"
                  icon="pi pi-arrow-right"
                  class="p-button-text p-button-sm"
                  (click)="navigateTo('/clientes')"
                ></button>
              </div>
            } @else {
              <div class="text-center py-4">
                <i
                  class="pi pi-check-circle text-green-500"
                  style="font-size: 3rem"
                ></i>
                <p class="mt-2 text-color-secondary">Todos los pagos al día</p>
              </div>
            }
          </p-card>
        </div>
      }

      <!-- Citas del Día -->
      <div class="col-12">
        <p-card>
          <ng-template pTemplate="header">
            <div class="card-header-custom">
              <h3>
                <i class="pi pi-calendar-plus text-blue-500 mr-2"></i>
                Citas de Hoy
              </h3>
              <p-chip
                [label]="citasHoy().length.toString()"
                styleClass="bg-blue-100 text-blue-700"
              />
            </div>
          </ng-template>

          @if (citasHoy().length > 0) {
            <p-table
              [value]="citasHoy()"
              [tableStyle]="{ 'min-width': '100%' }"
              styleClass="p-datatable-sm"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th>Hora</th>
                  <th>Cliente</th>
                  <th>Mascota</th>
                  <th>Motivo</th>
                  <th class="text-center">Acción</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-cita>
                <tr>
                  <td>
                    <span class="font-semibold">{{ cita.hora }}</span>
                  </td>
                  <td>{{ cita.cliente }}</td>
                  <td>
                    <i class="pi pi-heart-fill text-pink-500 mr-1"></i>
                    {{ cita.mascota }}
                  </td>
                  <td>{{ cita.motivo }}</td>
                  <td class="text-center">
                    <button
                      pButton
                      icon="pi pi-eye"
                      class="p-button-rounded p-button-text p-button-sm"
                      pTooltip="Ver detalle"
                      (click)="navigateTo('/citas')"
                    ></button>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          } @else {
            <div class="text-center py-4">
              <i
                class="pi pi-calendar-times text-color-secondary"
                style="font-size: 3rem"
              ></i>
              <p class="mt-2 text-color-secondary">
                No hay citas programadas para hoy
              </p>
            </div>
          }

          <ng-template pTemplate="footer">
            <div class="text-center">
              <button
                pButton
                label="Ver Todas las Citas"
                icon="pi pi-arrow-right"
                class="p-button-text p-button-sm"
                (click)="navigateTo('/citas')"
              ></button>
            </div>
          </ng-template>
        </p-card>
      </div>
    </div>

    <!-- Accesos Rápidos -->
    <div class="mt-4">
      <h3 class="text-xl font-semibold mb-3">Accesos Rápidos</h3>
      <div class="grid">
        @if (isAdmin() || isVendedor()) {
          <div class="col-12 sm:col-6 md:col-4 lg:col-3">
            <button
              pButton
              label="Nueva Venta"
              icon="pi pi-shopping-cart"
              class="p-button-success w-full"
              (click)="navigateTo('/ventas/nueva')"
            ></button>
          </div>
        }

        @if (isAdmin() || isVendedor()) {
          <div class="col-12 sm:col-6 md:col-4 lg:col-3">
            <button
              pButton
              label="Agendar Cita"
              icon="pi pi-calendar-plus"
              class="p-button-info w-full"
              (click)="navigateTo('/citas/nueva')"
            ></button>
          </div>
        }

        @if (isAdmin() || isVendedor()) {
          <div class="col-12 sm:col-6 md:col-4 lg:col-3">
            <button
              pButton
              label="Nuevo Cliente"
              icon="pi pi-user-plus"
              class="p-button-help w-full"
              (click)="navigateTo('/clientes/nuevo')"
            ></button>
          </div>
        }

        <div class="col-12 sm:col-6 md:col-4 lg:col-3">
          <button
            pButton
            label="Ver Mascotas"
            icon="pi pi-heart"
            class="p-button-warning w-full"
            (click)="navigateTo('/mascotas')"
          ></button>
        </div>
      </div>
    </div>
  }
</div>
